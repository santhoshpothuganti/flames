import { Construct } from 'constructs';
import { Bucket, HttpMethods, } from 'aws-cdk-lib/aws-s3';
import { RemovalPolicy, Stack } from 'aws-cdk-lib';
import { AttributionMetadataStorage } from '@aws-amplify/backend-output-storage';
import { fileURLToPath } from 'node:url';
import { S3EventSourceV2 } from 'aws-cdk-lib/aws-lambda-event-sources';
// Be very careful editing this value. It is the string that is used to attribute stacks to Amplify Storage in BI metrics
const storageStackType = 'storage-S3';
/**
 * Amplify Storage CDK Construct
 *
 * Currently just a thin wrapper around an S3 bucket
 */
export class AmplifyStorage extends Construct {
    stack;
    resources;
    isDefault;
    name;
    /**
     * Create a new AmplifyStorage instance
     */
    constructor(scope, id, props) {
        super(scope, id);
        this.isDefault = props.isDefault || false;
        this.name = props.name;
        this.stack = Stack.of(scope);
        const bucketProps = {
            versioned: props.versioned || false,
            cors: [
                {
                    maxAge: 3000,
                    exposedHeaders: [
                        'x-amz-server-side-encryption',
                        'x-amz-request-id',
                        'x-amz-id-2',
                        'ETag',
                    ],
                    allowedHeaders: ['*'],
                    allowedOrigins: ['*'],
                    allowedMethods: [
                        HttpMethods.GET,
                        HttpMethods.HEAD,
                        HttpMethods.PUT,
                        HttpMethods.POST,
                        HttpMethods.DELETE,
                    ],
                },
            ],
            autoDeleteObjects: true,
            removalPolicy: RemovalPolicy.DESTROY,
            enforceSSL: true,
        };
        const bucket = new Bucket(this, 'Bucket', bucketProps);
        this.resources = {
            bucket,
            cfnResources: {
                cfnBucket: bucket.node.findChild('Resource'),
            },
        };
        new AttributionMetadataStorage().storeAttributionMetadata(Stack.of(this), storageStackType, fileURLToPath(new URL('../package.json', import.meta.url)));
    }
    /**
     * Attach a Lambda function trigger handler to the S3 events
     * @param events - list of S3 events that will trigger the handler
     * @param handler - The function that will handle the event
     */
    addTrigger = (events, handler) => {
        handler.addEventSource(new S3EventSourceV2(this.resources.bucket, { events }));
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29uc3RydWN0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL2NvbnN0cnVjdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sWUFBWSxDQUFDO0FBQ3ZDLE9BQU8sRUFDTCxNQUFNLEVBSU4sV0FBVyxHQUVaLE1BQU0sb0JBQW9CLENBQUM7QUFTNUIsT0FBTyxFQUFFLGFBQWEsRUFBRSxLQUFLLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDbkQsT0FBTyxFQUFFLDBCQUEwQixFQUFFLE1BQU0scUNBQXFDLENBQUM7QUFDakYsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLFVBQVUsQ0FBQztBQUV6QyxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sc0NBQXNDLENBQUM7QUFFdkUseUhBQXlIO0FBQ3pILE1BQU0sZ0JBQWdCLEdBQUcsWUFBWSxDQUFDO0FBaUR0Qzs7OztHQUlHO0FBQ0gsTUFBTSxPQUFPLGNBQ1gsU0FBUSxTQUFTO0lBR1IsS0FBSyxDQUFRO0lBQ2IsU0FBUyxDQUFtQjtJQUM1QixTQUFTLENBQVU7SUFDbkIsSUFBSSxDQUFTO0lBQ3RCOztPQUVHO0lBQ0gsWUFBWSxLQUFnQixFQUFFLEVBQVUsRUFBRSxLQUEwQjtRQUNsRSxLQUFLLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBQ2pCLElBQUksQ0FBQyxTQUFTLEdBQUcsS0FBSyxDQUFDLFNBQVMsSUFBSSxLQUFLLENBQUM7UUFDMUMsSUFBSSxDQUFDLElBQUksR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDO1FBQ3ZCLElBQUksQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDLEVBQUUsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUU3QixNQUFNLFdBQVcsR0FBZ0I7WUFDL0IsU0FBUyxFQUFFLEtBQUssQ0FBQyxTQUFTLElBQUksS0FBSztZQUNuQyxJQUFJLEVBQUU7Z0JBQ0o7b0JBQ0UsTUFBTSxFQUFFLElBQUk7b0JBQ1osY0FBYyxFQUFFO3dCQUNkLDhCQUE4Qjt3QkFDOUIsa0JBQWtCO3dCQUNsQixZQUFZO3dCQUNaLE1BQU07cUJBQ1A7b0JBQ0QsY0FBYyxFQUFFLENBQUMsR0FBRyxDQUFDO29CQUNyQixjQUFjLEVBQUUsQ0FBQyxHQUFHLENBQUM7b0JBQ3JCLGNBQWMsRUFBRTt3QkFDZCxXQUFXLENBQUMsR0FBRzt3QkFDZixXQUFXLENBQUMsSUFBSTt3QkFDaEIsV0FBVyxDQUFDLEdBQUc7d0JBQ2YsV0FBVyxDQUFDLElBQUk7d0JBQ2hCLFdBQVcsQ0FBQyxNQUFNO3FCQUNuQjtpQkFDRjthQUNGO1lBQ0QsaUJBQWlCLEVBQUUsSUFBSTtZQUN2QixhQUFhLEVBQUUsYUFBYSxDQUFDLE9BQU87WUFDcEMsVUFBVSxFQUFFLElBQUk7U0FDakIsQ0FBQztRQUVGLE1BQU0sTUFBTSxHQUFHLElBQUksTUFBTSxDQUFDLElBQUksRUFBRSxRQUFRLEVBQUUsV0FBVyxDQUFDLENBQUM7UUFFdkQsSUFBSSxDQUFDLFNBQVMsR0FBRztZQUNmLE1BQU07WUFDTixZQUFZLEVBQUU7Z0JBQ1osU0FBUyxFQUFFLE1BQU0sQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLFVBQVUsQ0FBYzthQUMxRDtTQUNGLENBQUM7UUFFRixJQUFJLDBCQUEwQixFQUFFLENBQUMsd0JBQXdCLENBQ3ZELEtBQUssQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLEVBQ2QsZ0JBQWdCLEVBQ2hCLGFBQWEsQ0FBQyxJQUFJLEdBQUcsQ0FBQyxpQkFBaUIsRUFBRSxNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQzNELENBQUM7SUFDSixDQUFDO0lBRUQ7Ozs7T0FJRztJQUNILFVBQVUsR0FBRyxDQUFDLE1BQW1CLEVBQUUsT0FBa0IsRUFBUSxFQUFFO1FBQzdELE9BQU8sQ0FBQyxjQUFjLENBQ3BCLElBQUksZUFBZSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsTUFBTSxFQUFFLEVBQUUsTUFBTSxFQUFFLENBQUMsQ0FDdkQsQ0FBQztJQUNKLENBQUMsQ0FBQztDQUNIIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29uc3RydWN0IH0gZnJvbSAnY29uc3RydWN0cyc7XG5pbXBvcnQge1xuICBCdWNrZXQsXG4gIEJ1Y2tldFByb3BzLFxuICBDZm5CdWNrZXQsXG4gIEV2ZW50VHlwZSxcbiAgSHR0cE1ldGhvZHMsXG4gIElCdWNrZXQsXG59IGZyb20gJ2F3cy1jZGstbGliL2F3cy1zMyc7XG5pbXBvcnQge1xuICBCYWNrZW5kT3V0cHV0U3RvcmFnZVN0cmF0ZWd5LFxuICBDb25zdHJ1Y3RGYWN0b3J5LFxuICBGdW5jdGlvblJlc291cmNlcyxcbiAgUmVzb3VyY2VQcm92aWRlcixcbiAgU3RhY2tQcm92aWRlcixcbn0gZnJvbSAnQGF3cy1hbXBsaWZ5L3BsdWdpbi10eXBlcyc7XG5pbXBvcnQgeyBTdG9yYWdlT3V0cHV0IH0gZnJvbSAnQGF3cy1hbXBsaWZ5L2JhY2tlbmQtb3V0cHV0LXNjaGVtYXMnO1xuaW1wb3J0IHsgUmVtb3ZhbFBvbGljeSwgU3RhY2sgfSBmcm9tICdhd3MtY2RrLWxpYic7XG5pbXBvcnQgeyBBdHRyaWJ1dGlvbk1ldGFkYXRhU3RvcmFnZSB9IGZyb20gJ0Bhd3MtYW1wbGlmeS9iYWNrZW5kLW91dHB1dC1zdG9yYWdlJztcbmltcG9ydCB7IGZpbGVVUkxUb1BhdGggfSBmcm9tICdub2RlOnVybCc7XG5pbXBvcnQgeyBJRnVuY3Rpb24gfSBmcm9tICdhd3MtY2RrLWxpYi9hd3MtbGFtYmRhJztcbmltcG9ydCB7IFMzRXZlbnRTb3VyY2VWMiB9IGZyb20gJ2F3cy1jZGstbGliL2F3cy1sYW1iZGEtZXZlbnQtc291cmNlcyc7XG5cbi8vIEJlIHZlcnkgY2FyZWZ1bCBlZGl0aW5nIHRoaXMgdmFsdWUuIEl0IGlzIHRoZSBzdHJpbmcgdGhhdCBpcyB1c2VkIHRvIGF0dHJpYnV0ZSBzdGFja3MgdG8gQW1wbGlmeSBTdG9yYWdlIGluIEJJIG1ldHJpY3NcbmNvbnN0IHN0b3JhZ2VTdGFja1R5cGUgPSAnc3RvcmFnZS1TMyc7XG5cbmV4cG9ydCB0eXBlIEFtcGxpZnlTdG9yYWdlVHJpZ2dlckV2ZW50ID0gJ29uRGVsZXRlJyB8ICdvblVwbG9hZCc7XG5cbmV4cG9ydCB0eXBlIEFtcGxpZnlTdG9yYWdlUHJvcHMgPSB7XG4gIC8qKlxuICAgKiBXaGV0aGVyIHRoaXMgc3RvcmFnZSByZXNvdXJjZSBpcyB0aGUgZGVmYXVsdCBzdG9yYWdlIHJlc291cmNlIGZvciB0aGUgYmFja2VuZC5cbiAgICogcmVxdWlyZWQgYW5kIHJlbGV2YW50IG9ubHkgaWYgdGhlcmUgYXJlIG11bHRpcGxlIHN0b3JhZ2UgcmVzb3VyY2VzIGRlZmluZWQuXG4gICAqIEBkZWZhdWx0IGZhbHNlLlxuICAgKi9cbiAgaXNEZWZhdWx0PzogYm9vbGVhbjtcbiAgLyoqXG4gICAqIEZyaWVuZGx5IG5hbWUgdGhhdCB3aWxsIGJlIHVzZWQgdG8gZGVyaXZlIHRoZSBTMyBCdWNrZXQgbmFtZVxuICAgKi9cbiAgbmFtZTogc3RyaW5nO1xuICAvKipcbiAgICogV2hldGhlciB0byBlbmFibGUgUzMgb2JqZWN0IHZlcnNpb25pbmcgb24gdGhlIGJ1Y2tldC5cbiAgICogQHNlZSBodHRwczovL2RvY3MuYXdzLmFtYXpvbi5jb20vQW1hem9uUzMvbGF0ZXN0L3VzZXJndWlkZS9WZXJzaW9uaW5nLmh0bWxcbiAgICogQGRlZmF1bHQgZmFsc2VcbiAgICovXG4gIHZlcnNpb25lZD86IGJvb2xlYW47XG4gIG91dHB1dFN0b3JhZ2VTdHJhdGVneT86IEJhY2tlbmRPdXRwdXRTdG9yYWdlU3RyYXRlZ3k8U3RvcmFnZU91dHB1dD47XG4gIC8qKlxuICAgKiBTMyBldmVudCB0cmlnZ2VyIGNvbmZpZ3VyYXRpb25cbiAgICogQHNlZSBodHRwczovL2RvY3MuYW1wbGlmeS5hd3MvZ2VuMi9idWlsZC1hLWJhY2tlbmQvc3RvcmFnZS8jY29uZmlndXJlLXN0b3JhZ2UtdHJpZ2dlcnNcbiAgICogQGV4YW1wbGVcbiAgICogaW1wb3J0IHsgdHJpZ2dlckhhbmRsZXIgfSBmcm9tICcuLi9mdW5jdGlvbnMvdHJpZ2dlci1oYW5kbGVyL3Jlc291cmNlLnRzJ1xuICAgKlxuICAgKiBleHBvcnQgY29uc3Qgc3RvcmFnZSA9IGRlZmluZVN0b3JhZ2Uoe1xuICAgKiAgIHRyaWdnZXJzOiB7XG4gICAqICAgICBvblVwbG9hZDogdHJpZ2dlckhhbmRsZXJcbiAgICogICB9XG4gICAqIH0pXG4gICAqL1xuICB0cmlnZ2Vycz86IFBhcnRpYWw8XG4gICAgUmVjb3JkPFxuICAgICAgQW1wbGlmeVN0b3JhZ2VUcmlnZ2VyRXZlbnQsXG4gICAgICBDb25zdHJ1Y3RGYWN0b3J5PFJlc291cmNlUHJvdmlkZXI8RnVuY3Rpb25SZXNvdXJjZXM+PlxuICAgID5cbiAgPjtcbn07XG5cbmV4cG9ydCB0eXBlIFN0b3JhZ2VSZXNvdXJjZXMgPSB7XG4gIGJ1Y2tldDogSUJ1Y2tldDtcbiAgY2ZuUmVzb3VyY2VzOiB7XG4gICAgY2ZuQnVja2V0OiBDZm5CdWNrZXQ7XG4gIH07XG59O1xuXG4vKipcbiAqIEFtcGxpZnkgU3RvcmFnZSBDREsgQ29uc3RydWN0XG4gKlxuICogQ3VycmVudGx5IGp1c3QgYSB0aGluIHdyYXBwZXIgYXJvdW5kIGFuIFMzIGJ1Y2tldFxuICovXG5leHBvcnQgY2xhc3MgQW1wbGlmeVN0b3JhZ2VcbiAgZXh0ZW5kcyBDb25zdHJ1Y3RcbiAgaW1wbGVtZW50cyBSZXNvdXJjZVByb3ZpZGVyPFN0b3JhZ2VSZXNvdXJjZXM+LCBTdGFja1Byb3ZpZGVyXG57XG4gIHJlYWRvbmx5IHN0YWNrOiBTdGFjaztcbiAgcmVhZG9ubHkgcmVzb3VyY2VzOiBTdG9yYWdlUmVzb3VyY2VzO1xuICByZWFkb25seSBpc0RlZmF1bHQ6IGJvb2xlYW47XG4gIHJlYWRvbmx5IG5hbWU6IHN0cmluZztcbiAgLyoqXG4gICAqIENyZWF0ZSBhIG5ldyBBbXBsaWZ5U3RvcmFnZSBpbnN0YW5jZVxuICAgKi9cbiAgY29uc3RydWN0b3Ioc2NvcGU6IENvbnN0cnVjdCwgaWQ6IHN0cmluZywgcHJvcHM6IEFtcGxpZnlTdG9yYWdlUHJvcHMpIHtcbiAgICBzdXBlcihzY29wZSwgaWQpO1xuICAgIHRoaXMuaXNEZWZhdWx0ID0gcHJvcHMuaXNEZWZhdWx0IHx8IGZhbHNlO1xuICAgIHRoaXMubmFtZSA9IHByb3BzLm5hbWU7XG4gICAgdGhpcy5zdGFjayA9IFN0YWNrLm9mKHNjb3BlKTtcblxuICAgIGNvbnN0IGJ1Y2tldFByb3BzOiBCdWNrZXRQcm9wcyA9IHtcbiAgICAgIHZlcnNpb25lZDogcHJvcHMudmVyc2lvbmVkIHx8IGZhbHNlLFxuICAgICAgY29yczogW1xuICAgICAgICB7XG4gICAgICAgICAgbWF4QWdlOiAzMDAwLFxuICAgICAgICAgIGV4cG9zZWRIZWFkZXJzOiBbXG4gICAgICAgICAgICAneC1hbXotc2VydmVyLXNpZGUtZW5jcnlwdGlvbicsXG4gICAgICAgICAgICAneC1hbXotcmVxdWVzdC1pZCcsXG4gICAgICAgICAgICAneC1hbXotaWQtMicsXG4gICAgICAgICAgICAnRVRhZycsXG4gICAgICAgICAgXSxcbiAgICAgICAgICBhbGxvd2VkSGVhZGVyczogWycqJ10sXG4gICAgICAgICAgYWxsb3dlZE9yaWdpbnM6IFsnKiddLFxuICAgICAgICAgIGFsbG93ZWRNZXRob2RzOiBbXG4gICAgICAgICAgICBIdHRwTWV0aG9kcy5HRVQsXG4gICAgICAgICAgICBIdHRwTWV0aG9kcy5IRUFELFxuICAgICAgICAgICAgSHR0cE1ldGhvZHMuUFVULFxuICAgICAgICAgICAgSHR0cE1ldGhvZHMuUE9TVCxcbiAgICAgICAgICAgIEh0dHBNZXRob2RzLkRFTEVURSxcbiAgICAgICAgICBdLFxuICAgICAgICB9LFxuICAgICAgXSxcbiAgICAgIGF1dG9EZWxldGVPYmplY3RzOiB0cnVlLFxuICAgICAgcmVtb3ZhbFBvbGljeTogUmVtb3ZhbFBvbGljeS5ERVNUUk9ZLFxuICAgICAgZW5mb3JjZVNTTDogdHJ1ZSxcbiAgICB9O1xuXG4gICAgY29uc3QgYnVja2V0ID0gbmV3IEJ1Y2tldCh0aGlzLCAnQnVja2V0JywgYnVja2V0UHJvcHMpO1xuXG4gICAgdGhpcy5yZXNvdXJjZXMgPSB7XG4gICAgICBidWNrZXQsXG4gICAgICBjZm5SZXNvdXJjZXM6IHtcbiAgICAgICAgY2ZuQnVja2V0OiBidWNrZXQubm9kZS5maW5kQ2hpbGQoJ1Jlc291cmNlJykgYXMgQ2ZuQnVja2V0LFxuICAgICAgfSxcbiAgICB9O1xuXG4gICAgbmV3IEF0dHJpYnV0aW9uTWV0YWRhdGFTdG9yYWdlKCkuc3RvcmVBdHRyaWJ1dGlvbk1ldGFkYXRhKFxuICAgICAgU3RhY2sub2YodGhpcyksXG4gICAgICBzdG9yYWdlU3RhY2tUeXBlLFxuICAgICAgZmlsZVVSTFRvUGF0aChuZXcgVVJMKCcuLi9wYWNrYWdlLmpzb24nLCBpbXBvcnQubWV0YS51cmwpKVxuICAgICk7XG4gIH1cblxuICAvKipcbiAgICogQXR0YWNoIGEgTGFtYmRhIGZ1bmN0aW9uIHRyaWdnZXIgaGFuZGxlciB0byB0aGUgUzMgZXZlbnRzXG4gICAqIEBwYXJhbSBldmVudHMgLSBsaXN0IG9mIFMzIGV2ZW50cyB0aGF0IHdpbGwgdHJpZ2dlciB0aGUgaGFuZGxlclxuICAgKiBAcGFyYW0gaGFuZGxlciAtIFRoZSBmdW5jdGlvbiB0aGF0IHdpbGwgaGFuZGxlIHRoZSBldmVudFxuICAgKi9cbiAgYWRkVHJpZ2dlciA9IChldmVudHM6IEV2ZW50VHlwZVtdLCBoYW5kbGVyOiBJRnVuY3Rpb24pOiB2b2lkID0+IHtcbiAgICBoYW5kbGVyLmFkZEV2ZW50U291cmNlKFxuICAgICAgbmV3IFMzRXZlbnRTb3VyY2VWMih0aGlzLnJlc291cmNlcy5idWNrZXQsIHsgZXZlbnRzIH0pXG4gICAgKTtcbiAgfTtcbn1cbiJdfQ==