import { storageOutputKey, } from '@aws-amplify/backend-output-schemas';
import { AmplifyUserError } from '@aws-amplify/platform-core';
import { Stack } from 'aws-cdk-lib';
import { AmplifyStorage } from './construct.js';
/**
 * Aspect to store the storage outputs in the backend
 */
export class StorageOutputsAspect {
    isStorageProcessed = false;
    outputStorageStrategy;
    /**
     * Constructs a new instance of the StorageValidator class.
     */
    constructor(outputStorageStrategy) {
        this.outputStorageStrategy = outputStorageStrategy;
    }
    /**
     * Visit the given node.
     * If the node is an AmplifyStorage construct, we will traverse its siblings in the same stack
     * @param node The node to visit.
     */
    visit(node) {
        if (!(node instanceof AmplifyStorage) || this.isStorageProcessed) {
            return;
        }
        /**
         * only traverse the siblings once to store the outputs,
         * storing the same outputs multiple times result in error
         */
        this.isStorageProcessed = true;
        const storageInstances = Stack.of(node).node.children.filter((el) => el instanceof AmplifyStorage);
        const storageCount = storageInstances.length;
        let defaultStorageFound = false;
        Stack.of(node).node.children.forEach((child) => {
            if (!(child instanceof AmplifyStorage)) {
                return;
            }
            if (child.isDefault && !defaultStorageFound) {
                defaultStorageFound = true;
            }
            else if (child.isDefault && defaultStorageFound) {
                throw new AmplifyUserError('MultipleDefaultStorageError', {
                    message: `More than one default storage set in the Amplify project.`,
                    resolution: 'Remove `isDefault: true` from all `defineStorage` calls except for one in your Amplify project.',
                });
            }
        });
        /*
         * If there is no default bucket set and there is only one bucket,
         * we need to set the bucket as default.
         */
        if (!defaultStorageFound && storageCount === 1) {
            this.storeOutput(this.outputStorageStrategy, true, node);
        }
        else if (!defaultStorageFound && storageCount > 1) {
            throw new AmplifyUserError('NoDefaultStorageError', {
                message: 'No default storage set in the Amplify project.',
                resolution: 'Add `isDefault: true` to one of the `defineStorage` calls in your Amplify project.',
            });
        }
        else {
            Stack.of(node).node.children.forEach((child) => {
                if (!(child instanceof AmplifyStorage)) {
                    return;
                }
                this.storeOutput(this.outputStorageStrategy, child.isDefault, child);
            });
        }
    }
    storeOutput = (outputStorageStrategy, isDefault = false, node) => {
        if (isDefault) {
            outputStorageStrategy.addBackendOutputEntry(storageOutputKey, {
                version: '1',
                payload: {
                    storageRegion: Stack.of(node).region,
                    bucketName: node.resources.bucket.bucketName,
                },
            });
        }
        // both default and non-default buckets should have the name, bucket name, and storage region stored in `buckets` field
        outputStorageStrategy.appendToBackendOutputList(storageOutputKey, {
            version: '1',
            payload: {
                buckets: JSON.stringify({
                    name: node.name,
                    bucketName: node.resources.bucket.bucketName,
                    storageRegion: Stack.of(node).region,
                }),
            },
        });
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RvcmFnZV9vdXRwdXRzX2FzcGVjdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9zdG9yYWdlX291dHB1dHNfYXNwZWN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFFTCxnQkFBZ0IsR0FDakIsTUFBTSxxQ0FBcUMsQ0FBQztBQUM3QyxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUU5RCxPQUFPLEVBQVcsS0FBSyxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBRTdDLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUVoRDs7R0FFRztBQUNILE1BQU0sT0FBTyxvQkFBb0I7SUFDL0Isa0JBQWtCLEdBQUcsS0FBSyxDQUFDO0lBQzNCLHFCQUFxQixDQUFDO0lBQ3RCOztPQUVHO0lBQ0gsWUFDRSxxQkFBa0U7UUFFbEUsSUFBSSxDQUFDLHFCQUFxQixHQUFHLHFCQUFxQixDQUFDO0lBQ3JELENBQUM7SUFFRDs7OztPQUlHO0lBQ0ksS0FBSyxDQUFDLElBQWdCO1FBQzNCLElBQUksQ0FBQyxDQUFDLElBQUksWUFBWSxjQUFjLENBQUMsSUFBSSxJQUFJLENBQUMsa0JBQWtCLEVBQUU7WUFDaEUsT0FBTztTQUNSO1FBQ0Q7OztXQUdHO1FBQ0gsSUFBSSxDQUFDLGtCQUFrQixHQUFHLElBQUksQ0FBQztRQUUvQixNQUFNLGdCQUFnQixHQUFHLEtBQUssQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQzFELENBQUMsRUFBRSxFQUFFLEVBQUUsQ0FBQyxFQUFFLFlBQVksY0FBYyxDQUNyQyxDQUFDO1FBQ0YsTUFBTSxZQUFZLEdBQUcsZ0JBQWdCLENBQUMsTUFBTSxDQUFDO1FBRTdDLElBQUksbUJBQW1CLEdBQUcsS0FBSyxDQUFDO1FBRWhDLEtBQUssQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsQ0FBQyxLQUFLLEVBQUUsRUFBRTtZQUM3QyxJQUFJLENBQUMsQ0FBQyxLQUFLLFlBQVksY0FBYyxDQUFDLEVBQUU7Z0JBQ3RDLE9BQU87YUFDUjtZQUNELElBQUksS0FBSyxDQUFDLFNBQVMsSUFBSSxDQUFDLG1CQUFtQixFQUFFO2dCQUMzQyxtQkFBbUIsR0FBRyxJQUFJLENBQUM7YUFDNUI7aUJBQU0sSUFBSSxLQUFLLENBQUMsU0FBUyxJQUFJLG1CQUFtQixFQUFFO2dCQUNqRCxNQUFNLElBQUksZ0JBQWdCLENBQUMsNkJBQTZCLEVBQUU7b0JBQ3hELE9BQU8sRUFBRSwyREFBMkQ7b0JBQ3BFLFVBQVUsRUFDUixpR0FBaUc7aUJBQ3BHLENBQUMsQ0FBQzthQUNKO1FBQ0gsQ0FBQyxDQUFDLENBQUM7UUFDSDs7O1dBR0c7UUFDSCxJQUFJLENBQUMsbUJBQW1CLElBQUksWUFBWSxLQUFLLENBQUMsRUFBRTtZQUM5QyxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxxQkFBcUIsRUFBRSxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUM7U0FDMUQ7YUFBTSxJQUFJLENBQUMsbUJBQW1CLElBQUksWUFBWSxHQUFHLENBQUMsRUFBRTtZQUNuRCxNQUFNLElBQUksZ0JBQWdCLENBQUMsdUJBQXVCLEVBQUU7Z0JBQ2xELE9BQU8sRUFBRSxnREFBZ0Q7Z0JBQ3pELFVBQVUsRUFDUixvRkFBb0Y7YUFDdkYsQ0FBQyxDQUFDO1NBQ0o7YUFBTTtZQUNMLEtBQUssQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsQ0FBQyxLQUFLLEVBQUUsRUFBRTtnQkFDN0MsSUFBSSxDQUFDLENBQUMsS0FBSyxZQUFZLGNBQWMsQ0FBQyxFQUFFO29CQUN0QyxPQUFPO2lCQUNSO2dCQUNELElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLHFCQUFxQixFQUFFLEtBQUssQ0FBQyxTQUFTLEVBQUUsS0FBSyxDQUFDLENBQUM7WUFDdkUsQ0FBQyxDQUFDLENBQUM7U0FDSjtJQUNILENBQUM7SUFFTyxXQUFXLEdBQUcsQ0FDcEIscUJBQWtFLEVBQ2xFLFlBQXFCLEtBQUssRUFDMUIsSUFBb0IsRUFDZCxFQUFFO1FBQ1IsSUFBSSxTQUFTLEVBQUU7WUFDYixxQkFBcUIsQ0FBQyxxQkFBcUIsQ0FBQyxnQkFBZ0IsRUFBRTtnQkFDNUQsT0FBTyxFQUFFLEdBQUc7Z0JBQ1osT0FBTyxFQUFFO29CQUNQLGFBQWEsRUFBRSxLQUFLLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDLE1BQU07b0JBQ3BDLFVBQVUsRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxVQUFVO2lCQUM3QzthQUNGLENBQUMsQ0FBQztTQUNKO1FBRUQsdUhBQXVIO1FBQ3ZILHFCQUFxQixDQUFDLHlCQUF5QixDQUFDLGdCQUFnQixFQUFFO1lBQ2hFLE9BQU8sRUFBRSxHQUFHO1lBQ1osT0FBTyxFQUFFO2dCQUNQLE9BQU8sRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDO29CQUN0QixJQUFJLEVBQUUsSUFBSSxDQUFDLElBQUk7b0JBQ2YsVUFBVSxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLFVBQVU7b0JBQzVDLGFBQWEsRUFBRSxLQUFLLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDLE1BQU07aUJBQ3JDLENBQUM7YUFDSDtTQUNGLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQztDQUNIIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgU3RvcmFnZU91dHB1dCxcbiAgc3RvcmFnZU91dHB1dEtleSxcbn0gZnJvbSAnQGF3cy1hbXBsaWZ5L2JhY2tlbmQtb3V0cHV0LXNjaGVtYXMnO1xuaW1wb3J0IHsgQW1wbGlmeVVzZXJFcnJvciB9IGZyb20gJ0Bhd3MtYW1wbGlmeS9wbGF0Zm9ybS1jb3JlJztcbmltcG9ydCB7IEJhY2tlbmRPdXRwdXRTdG9yYWdlU3RyYXRlZ3kgfSBmcm9tICdAYXdzLWFtcGxpZnkvcGx1Z2luLXR5cGVzJztcbmltcG9ydCB7IElBc3BlY3QsIFN0YWNrIH0gZnJvbSAnYXdzLWNkay1saWInO1xuaW1wb3J0IHsgSUNvbnN0cnVjdCB9IGZyb20gJ2NvbnN0cnVjdHMnO1xuaW1wb3J0IHsgQW1wbGlmeVN0b3JhZ2UgfSBmcm9tICcuL2NvbnN0cnVjdC5qcyc7XG5cbi8qKlxuICogQXNwZWN0IHRvIHN0b3JlIHRoZSBzdG9yYWdlIG91dHB1dHMgaW4gdGhlIGJhY2tlbmRcbiAqL1xuZXhwb3J0IGNsYXNzIFN0b3JhZ2VPdXRwdXRzQXNwZWN0IGltcGxlbWVudHMgSUFzcGVjdCB7XG4gIGlzU3RvcmFnZVByb2Nlc3NlZCA9IGZhbHNlO1xuICBvdXRwdXRTdG9yYWdlU3RyYXRlZ3k7XG4gIC8qKlxuICAgKiBDb25zdHJ1Y3RzIGEgbmV3IGluc3RhbmNlIG9mIHRoZSBTdG9yYWdlVmFsaWRhdG9yIGNsYXNzLlxuICAgKi9cbiAgY29uc3RydWN0b3IoXG4gICAgb3V0cHV0U3RvcmFnZVN0cmF0ZWd5OiBCYWNrZW5kT3V0cHV0U3RvcmFnZVN0cmF0ZWd5PFN0b3JhZ2VPdXRwdXQ+XG4gICkge1xuICAgIHRoaXMub3V0cHV0U3RvcmFnZVN0cmF0ZWd5ID0gb3V0cHV0U3RvcmFnZVN0cmF0ZWd5O1xuICB9XG5cbiAgLyoqXG4gICAqIFZpc2l0IHRoZSBnaXZlbiBub2RlLlxuICAgKiBJZiB0aGUgbm9kZSBpcyBhbiBBbXBsaWZ5U3RvcmFnZSBjb25zdHJ1Y3QsIHdlIHdpbGwgdHJhdmVyc2UgaXRzIHNpYmxpbmdzIGluIHRoZSBzYW1lIHN0YWNrXG4gICAqIEBwYXJhbSBub2RlIFRoZSBub2RlIHRvIHZpc2l0LlxuICAgKi9cbiAgcHVibGljIHZpc2l0KG5vZGU6IElDb25zdHJ1Y3QpOiB2b2lkIHtcbiAgICBpZiAoIShub2RlIGluc3RhbmNlb2YgQW1wbGlmeVN0b3JhZ2UpIHx8IHRoaXMuaXNTdG9yYWdlUHJvY2Vzc2VkKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIC8qKlxuICAgICAqIG9ubHkgdHJhdmVyc2UgdGhlIHNpYmxpbmdzIG9uY2UgdG8gc3RvcmUgdGhlIG91dHB1dHMsXG4gICAgICogc3RvcmluZyB0aGUgc2FtZSBvdXRwdXRzIG11bHRpcGxlIHRpbWVzIHJlc3VsdCBpbiBlcnJvclxuICAgICAqL1xuICAgIHRoaXMuaXNTdG9yYWdlUHJvY2Vzc2VkID0gdHJ1ZTtcblxuICAgIGNvbnN0IHN0b3JhZ2VJbnN0YW5jZXMgPSBTdGFjay5vZihub2RlKS5ub2RlLmNoaWxkcmVuLmZpbHRlcihcbiAgICAgIChlbCkgPT4gZWwgaW5zdGFuY2VvZiBBbXBsaWZ5U3RvcmFnZVxuICAgICk7XG4gICAgY29uc3Qgc3RvcmFnZUNvdW50ID0gc3RvcmFnZUluc3RhbmNlcy5sZW5ndGg7XG5cbiAgICBsZXQgZGVmYXVsdFN0b3JhZ2VGb3VuZCA9IGZhbHNlO1xuXG4gICAgU3RhY2sub2Yobm9kZSkubm9kZS5jaGlsZHJlbi5mb3JFYWNoKChjaGlsZCkgPT4ge1xuICAgICAgaWYgKCEoY2hpbGQgaW5zdGFuY2VvZiBBbXBsaWZ5U3RvcmFnZSkpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgICAgaWYgKGNoaWxkLmlzRGVmYXVsdCAmJiAhZGVmYXVsdFN0b3JhZ2VGb3VuZCkge1xuICAgICAgICBkZWZhdWx0U3RvcmFnZUZvdW5kID0gdHJ1ZTtcbiAgICAgIH0gZWxzZSBpZiAoY2hpbGQuaXNEZWZhdWx0ICYmIGRlZmF1bHRTdG9yYWdlRm91bmQpIHtcbiAgICAgICAgdGhyb3cgbmV3IEFtcGxpZnlVc2VyRXJyb3IoJ011bHRpcGxlRGVmYXVsdFN0b3JhZ2VFcnJvcicsIHtcbiAgICAgICAgICBtZXNzYWdlOiBgTW9yZSB0aGFuIG9uZSBkZWZhdWx0IHN0b3JhZ2Ugc2V0IGluIHRoZSBBbXBsaWZ5IHByb2plY3QuYCxcbiAgICAgICAgICByZXNvbHV0aW9uOlxuICAgICAgICAgICAgJ1JlbW92ZSBgaXNEZWZhdWx0OiB0cnVlYCBmcm9tIGFsbCBgZGVmaW5lU3RvcmFnZWAgY2FsbHMgZXhjZXB0IGZvciBvbmUgaW4geW91ciBBbXBsaWZ5IHByb2plY3QuJyxcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgfSk7XG4gICAgLypcbiAgICAgKiBJZiB0aGVyZSBpcyBubyBkZWZhdWx0IGJ1Y2tldCBzZXQgYW5kIHRoZXJlIGlzIG9ubHkgb25lIGJ1Y2tldCxcbiAgICAgKiB3ZSBuZWVkIHRvIHNldCB0aGUgYnVja2V0IGFzIGRlZmF1bHQuXG4gICAgICovXG4gICAgaWYgKCFkZWZhdWx0U3RvcmFnZUZvdW5kICYmIHN0b3JhZ2VDb3VudCA9PT0gMSkge1xuICAgICAgdGhpcy5zdG9yZU91dHB1dCh0aGlzLm91dHB1dFN0b3JhZ2VTdHJhdGVneSwgdHJ1ZSwgbm9kZSk7XG4gICAgfSBlbHNlIGlmICghZGVmYXVsdFN0b3JhZ2VGb3VuZCAmJiBzdG9yYWdlQ291bnQgPiAxKSB7XG4gICAgICB0aHJvdyBuZXcgQW1wbGlmeVVzZXJFcnJvcignTm9EZWZhdWx0U3RvcmFnZUVycm9yJywge1xuICAgICAgICBtZXNzYWdlOiAnTm8gZGVmYXVsdCBzdG9yYWdlIHNldCBpbiB0aGUgQW1wbGlmeSBwcm9qZWN0LicsXG4gICAgICAgIHJlc29sdXRpb246XG4gICAgICAgICAgJ0FkZCBgaXNEZWZhdWx0OiB0cnVlYCB0byBvbmUgb2YgdGhlIGBkZWZpbmVTdG9yYWdlYCBjYWxscyBpbiB5b3VyIEFtcGxpZnkgcHJvamVjdC4nLFxuICAgICAgfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIFN0YWNrLm9mKG5vZGUpLm5vZGUuY2hpbGRyZW4uZm9yRWFjaCgoY2hpbGQpID0+IHtcbiAgICAgICAgaWYgKCEoY2hpbGQgaW5zdGFuY2VvZiBBbXBsaWZ5U3RvcmFnZSkpIHtcbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5zdG9yZU91dHB1dCh0aGlzLm91dHB1dFN0b3JhZ2VTdHJhdGVneSwgY2hpbGQuaXNEZWZhdWx0LCBjaGlsZCk7XG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHN0b3JlT3V0cHV0ID0gKFxuICAgIG91dHB1dFN0b3JhZ2VTdHJhdGVneTogQmFja2VuZE91dHB1dFN0b3JhZ2VTdHJhdGVneTxTdG9yYWdlT3V0cHV0PixcbiAgICBpc0RlZmF1bHQ6IGJvb2xlYW4gPSBmYWxzZSxcbiAgICBub2RlOiBBbXBsaWZ5U3RvcmFnZVxuICApOiB2b2lkID0+IHtcbiAgICBpZiAoaXNEZWZhdWx0KSB7XG4gICAgICBvdXRwdXRTdG9yYWdlU3RyYXRlZ3kuYWRkQmFja2VuZE91dHB1dEVudHJ5KHN0b3JhZ2VPdXRwdXRLZXksIHtcbiAgICAgICAgdmVyc2lvbjogJzEnLFxuICAgICAgICBwYXlsb2FkOiB7XG4gICAgICAgICAgc3RvcmFnZVJlZ2lvbjogU3RhY2sub2Yobm9kZSkucmVnaW9uLFxuICAgICAgICAgIGJ1Y2tldE5hbWU6IG5vZGUucmVzb3VyY2VzLmJ1Y2tldC5idWNrZXROYW1lLFxuICAgICAgICB9LFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgLy8gYm90aCBkZWZhdWx0IGFuZCBub24tZGVmYXVsdCBidWNrZXRzIHNob3VsZCBoYXZlIHRoZSBuYW1lLCBidWNrZXQgbmFtZSwgYW5kIHN0b3JhZ2UgcmVnaW9uIHN0b3JlZCBpbiBgYnVja2V0c2AgZmllbGRcbiAgICBvdXRwdXRTdG9yYWdlU3RyYXRlZ3kuYXBwZW5kVG9CYWNrZW5kT3V0cHV0TGlzdChzdG9yYWdlT3V0cHV0S2V5LCB7XG4gICAgICB2ZXJzaW9uOiAnMScsXG4gICAgICBwYXlsb2FkOiB7XG4gICAgICAgIGJ1Y2tldHM6IEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgICBuYW1lOiBub2RlLm5hbWUsXG4gICAgICAgICAgYnVja2V0TmFtZTogbm9kZS5yZXNvdXJjZXMuYnVja2V0LmJ1Y2tldE5hbWUsXG4gICAgICAgICAgc3RvcmFnZVJlZ2lvbjogU3RhY2sub2Yobm9kZSkucmVnaW9uLFxuICAgICAgICB9KSxcbiAgICAgIH0sXG4gICAgfSk7XG4gIH07XG59XG4iXX0=