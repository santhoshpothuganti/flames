import { Construct } from 'constructs';
import { NodejsFunction, OutputFormat } from 'aws-cdk-lib/aws-lambda-nodejs';
import * as path from 'path';
import { Duration, Stack, Tags } from 'aws-cdk-lib';
import { Runtime } from 'aws-cdk-lib/aws-lambda';
import { createRequire } from 'module';
import { FunctionEnvironmentTranslator } from './function_env_translator.js';
import { readFileSync } from 'fs';
import { EOL } from 'os';
import { functionOutputKey, } from '@aws-amplify/backend-output-schemas';
import { FunctionEnvironmentTypeGenerator } from './function_env_type_generator.js';
import { AttributionMetadataStorage } from '@aws-amplify/backend-output-storage';
import { fileURLToPath } from 'node:url';
import { AmplifyUserError, CallerDirectoryExtractor, TagName, } from '@aws-amplify/platform-core';
import { convertFunctionSchedulesToRuleSchedules } from './schedule_parser.js';
import * as targets from 'aws-cdk-lib/aws-events-targets';
import { Rule } from 'aws-cdk-lib/aws-events';
const functionStackType = 'function-Lambda';
/**
 * Entry point for defining a function in the Amplify ecosystem
 */
export const defineFunction = (props = {}) => new FunctionFactory(props, new Error().stack);
/**
 * Create Lambda functions in the context of an Amplify backend definition
 */
class FunctionFactory {
    props;
    callerStack;
    generator;
    /**
     * Create a new AmplifyFunctionFactory
     */
    constructor(props, callerStack) {
        this.props = props;
        this.callerStack = callerStack;
    }
    /**
     * Creates an instance of AmplifyFunction within the provided Amplify context
     */
    getInstance = ({ constructContainer, outputStorageStrategy, resourceNameValidator, }) => {
        if (!this.generator) {
            this.generator = new FunctionGenerator(this.hydrateDefaults(resourceNameValidator), outputStorageStrategy);
        }
        return constructContainer.getOrCompute(this.generator);
    };
    hydrateDefaults = (resourceNameValidator) => {
        const name = this.resolveName();
        resourceNameValidator?.validate(name);
        return {
            name,
            entry: this.resolveEntry(),
            timeoutSeconds: this.resolveTimeout(),
            memoryMB: this.resolveMemory(),
            environment: this.props.environment ?? {},
            runtime: this.resolveRuntime(),
            schedule: this.resolveSchedule(),
        };
    };
    resolveName = () => {
        // If name is set explicitly, use that
        if (this.props.name) {
            return this.props.name;
        }
        // If entry is set, use the basename of the entry path
        if (this.props.entry) {
            return path.parse(this.props.entry).name;
        }
        // Otherwise, use the directory name where the function is defined
        return path.basename(new CallerDirectoryExtractor(this.callerStack).extract());
    };
    resolveEntry = () => {
        // if entry is not set, default to handler.ts
        if (!this.props.entry) {
            return path.join(new CallerDirectoryExtractor(this.callerStack).extract(), 'handler.ts');
        }
        // if entry is absolute use that
        if (path.isAbsolute(this.props.entry)) {
            return this.props.entry;
        }
        // if entry is relative, compute with respect to the caller directory
        return path.join(new CallerDirectoryExtractor(this.callerStack).extract(), this.props.entry);
    };
    resolveTimeout = () => {
        const timeoutMin = 1;
        const timeoutMax = 60 * 15; // 15 minutes in seconds
        const timeoutDefault = 3;
        if (this.props.timeoutSeconds === undefined) {
            return timeoutDefault;
        }
        if (!isWholeNumberBetweenInclusive(this.props.timeoutSeconds, timeoutMin, timeoutMax)) {
            throw new Error(`timeoutSeconds must be a whole number between ${timeoutMin} and ${timeoutMax} inclusive`);
        }
        return this.props.timeoutSeconds;
    };
    resolveMemory = () => {
        const memoryMin = 128;
        const memoryMax = 10240;
        const memoryDefault = 512;
        if (this.props.memoryMB === undefined) {
            return memoryDefault;
        }
        if (!isWholeNumberBetweenInclusive(this.props.memoryMB, memoryMin, memoryMax)) {
            throw new Error(`memoryMB must be a whole number between ${memoryMin} and ${memoryMax} inclusive`);
        }
        return this.props.memoryMB;
    };
    resolveRuntime = () => {
        const runtimeDefault = 18;
        // if runtime is not set, default to the oldest LTS
        if (!this.props.runtime) {
            return runtimeDefault;
        }
        if (!(this.props.runtime in nodeVersionMap)) {
            throw new Error(`runtime must be one of the following: ${Object.keys(nodeVersionMap).join(', ')}`);
        }
        return this.props.runtime;
    };
    resolveSchedule = () => {
        if (!this.props.schedule) {
            return [];
        }
        return this.props.schedule;
    };
}
class FunctionGenerator {
    props;
    outputStorageStrategy;
    resourceGroupName = 'function';
    constructor(props, outputStorageStrategy) {
        this.props = props;
        this.outputStorageStrategy = outputStorageStrategy;
    }
    generateContainerEntry = ({ scope, backendSecretResolver, }) => {
        return new AmplifyFunction(scope, this.props.name, this.props, backendSecretResolver, this.outputStorageStrategy);
    };
}
class AmplifyFunction extends Construct {
    resources;
    stack;
    functionEnvironmentTranslator;
    constructor(scope, id, props, backendSecretResolver, outputStorageStrategy) {
        super(scope, id);
        this.stack = Stack.of(scope);
        const runtime = nodeVersionMap[props.runtime];
        const require = createRequire(import.meta.url);
        const shims = runtime === Runtime.NODEJS_16_X
            ? []
            : [require.resolve('./lambda-shims/cjs_shim')];
        const ssmResolverFile = runtime === Runtime.NODEJS_16_X
            ? require.resolve('./lambda-shims/resolve_ssm_params_sdk_v2') // use aws cdk v2 in node 16
            : require.resolve('./lambda-shims/resolve_ssm_params');
        const invokeSsmResolverFile = require.resolve('./lambda-shims/invoke_ssm_shim');
        /**
         * This code concatenates the contents of the ssm resolver and invoker into a single line that can be used as the esbuild banner content
         * This banner is responsible for resolving the customer's SSM parameters at runtime
         */
        const bannerCode = readFileSync(ssmResolverFile, 'utf-8')
            .concat(readFileSync(invokeSsmResolverFile, 'utf-8'))
            .split(new RegExp(`${EOL}|\n|\r`, 'g'))
            .map((line) => line.replace(/\/\/.*$/, '')) // strip out inline comments because the banner is going to be flattened into a single line
            .join('');
        const functionEnvironmentTypeGenerator = new FunctionEnvironmentTypeGenerator(id);
        // esbuild runs as part of the NodejsFunction constructor, so we eagerly generate the process env shim without types so it can be included in the function bundle.
        // This will be overwritten with the typed file at the end of synthesis
        functionEnvironmentTypeGenerator.generateProcessEnvShim();
        let functionLambda;
        try {
            functionLambda = new NodejsFunction(scope, `${id}-lambda`, {
                entry: props.entry,
                timeout: Duration.seconds(props.timeoutSeconds),
                memorySize: props.memoryMB,
                runtime: nodeVersionMap[props.runtime],
                bundling: {
                    format: OutputFormat.ESM,
                    banner: bannerCode,
                    bundleAwsSDK: true,
                    inject: shims,
                    loader: {
                        '.node': 'file',
                    },
                    minify: true,
                    sourceMap: true,
                },
            });
        }
        catch (error) {
            // If the error is from ES Bundler which is executed as a child process by CDK,
            // then the error from CDK contains the command that was executed along with the exit status.
            // Wrapping it here  would cause the cdk_deployer to re-throw this wrapped exception
            // instead of scraping the stderr for actual ESBuild error.
            if (error instanceof Error &&
                error.message.match(/Failed to bundle asset.*exited with status/)) {
                throw error;
            }
            throw new AmplifyUserError('NodeJSFunctionConstructInitializationError', {
                message: 'Failed to instantiate nodejs function construct',
                resolution: 'See the underlying error message for more details. Use `--debug` for additional debugging information.',
            }, error);
        }
        try {
            const schedules = convertFunctionSchedulesToRuleSchedules(functionLambda, props.schedule);
            const lambdaTarget = new targets.LambdaFunction(functionLambda);
            schedules.forEach((schedule, index) => {
                // Lambda name will be prepended to rule id, so only using index here for uniqueness
                const rule = new Rule(functionLambda, `schedule${index}`, {
                    schedule,
                });
                rule.addTarget(lambdaTarget);
            });
        }
        catch (error) {
            throw new AmplifyUserError('FunctionScheduleInitializationError', {
                message: 'Failed to instantiate schedule for nodejs function',
                resolution: 'See the underlying error message for more details.',
            }, error);
        }
        Tags.of(functionLambda).add(TagName.FRIENDLY_NAME, id);
        this.functionEnvironmentTranslator = new FunctionEnvironmentTranslator(functionLambda, props.environment, backendSecretResolver, functionEnvironmentTypeGenerator);
        this.resources = {
            lambda: functionLambda,
            cfnResources: {
                cfnFunction: functionLambda.node.findChild('Resource'),
            },
        };
        this.storeOutput(outputStorageStrategy);
        new AttributionMetadataStorage().storeAttributionMetadata(Stack.of(this), functionStackType, fileURLToPath(new URL('../package.json', import.meta.url)));
    }
    addEnvironment = (key, value) => {
        this.functionEnvironmentTranslator.addEnvironmentEntry(key, value);
    };
    getResourceAccessAcceptor = () => ({
        identifier: `${this.node.id}LambdaResourceAccessAcceptor`,
        acceptResourceAccess: (policy, ssmEnvironmentEntries) => {
            const role = this.resources.lambda.role;
            if (!role) {
                // This should never happen since we are using the Function L2 construct
                throw new Error('No execution role found to attach lambda permissions to');
            }
            policy.attachToRole(role);
            ssmEnvironmentEntries.forEach(({ name, path }) => {
                this.functionEnvironmentTranslator.addSsmEnvironmentEntry(name, path);
            });
        },
    });
    /**
     * Store storage outputs using provided strategy
     */
    storeOutput = (outputStorageStrategy) => {
        outputStorageStrategy.appendToBackendOutputList(functionOutputKey, {
            version: '1',
            payload: {
                definedFunctions: this.resources.lambda.functionName,
            },
        });
    };
}
const isWholeNumberBetweenInclusive = (test, min, max) => min <= test && test <= max && test % 1 === 0;
const nodeVersionMap = {
    16: Runtime.NODEJS_16_X,
    18: Runtime.NODEJS_18_X,
    20: Runtime.NODEJS_20_X,
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmFjdG9yeS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9mYWN0b3J5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQWVBLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxZQUFZLENBQUM7QUFDdkMsT0FBTyxFQUFFLGNBQWMsRUFBRSxZQUFZLEVBQUUsTUFBTSwrQkFBK0IsQ0FBQztBQUM3RSxPQUFPLEtBQUssSUFBSSxNQUFNLE1BQU0sQ0FBQztBQUM3QixPQUFPLEVBQUUsUUFBUSxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDcEQsT0FBTyxFQUFlLE9BQU8sRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBQzlELE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxRQUFRLENBQUM7QUFDdkMsT0FBTyxFQUFFLDZCQUE2QixFQUFFLE1BQU0sOEJBQThCLENBQUM7QUFFN0UsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLElBQUksQ0FBQztBQUNsQyxPQUFPLEVBQUUsR0FBRyxFQUFFLE1BQU0sSUFBSSxDQUFDO0FBQ3pCLE9BQU8sRUFFTCxpQkFBaUIsR0FDbEIsTUFBTSxxQ0FBcUMsQ0FBQztBQUM3QyxPQUFPLEVBQUUsZ0NBQWdDLEVBQUUsTUFBTSxrQ0FBa0MsQ0FBQztBQUNwRixPQUFPLEVBQUUsMEJBQTBCLEVBQUUsTUFBTSxxQ0FBcUMsQ0FBQztBQUNqRixPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sVUFBVSxDQUFDO0FBQ3pDLE9BQU8sRUFDTCxnQkFBZ0IsRUFDaEIsd0JBQXdCLEVBQ3hCLE9BQU8sR0FDUixNQUFNLDRCQUE0QixDQUFDO0FBQ3BDLE9BQU8sRUFBRSx1Q0FBdUMsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQy9FLE9BQU8sS0FBSyxPQUFPLE1BQU0sZ0NBQWdDLENBQUM7QUFDMUQsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBRTlDLE1BQU0saUJBQWlCLEdBQUcs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LENBQUMsQ0FBQztJQUVIOztPQUVHO0lBQ0ssV0FBVyxHQUFHLENBQ3BCLHFCQUFtRSxFQUM3RCxFQUFFO1FBQ1IscUJBQXFCLENBQUMseUJBQXlCLENBQUMsaUJBQWlCLEVBQUU7WUFDakUsT0FBTyxFQUFFLEdBQUc7WUFDWixPQUFPLEVBQUU7Z0JBQ1AsZ0JBQWdCLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsWUFBWTthQUNyRDtTQUNGLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQztDQUNIO0FBRUQsTUFBTSw2QkFBNkIsR0FBRyxDQUNwQyxJQUFZLEVBQ1osR0FBVyxFQUNYLEdBQVcsRUFDWCxFQUFFLENBQUMsR0FBRyxJQUFJLElBQUksSUFBSSxJQUFJLElBQUksR0FBRyxJQUFJLElBQUksR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDO0FBSWxELE1BQU0sY0FBYyxHQUFpQztJQUNuRCxFQUFFLEVBQUUsT0FBTyxDQUFDLFdBQVc7SUFDdkIsRUFBRSxFQUFFLE9BQU8sQ0FBQyxXQUFXO0lBQ3ZCLEVBQUUsRUFBRSxPQUFPLENBQUMsV0FBVztDQUN4QixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgQmFja2VuZE91dHB1dFN0b3JhZ2VTdHJhdGVneSxcbiAgQmFja2VuZFNlY3JldCxcbiAgQmFja2VuZFNlY3JldFJlc29sdmVyLFxuICBDb25zdHJ1Y3RDb250YWluZXJFbnRyeUdlbmVyYXRvcixcbiAgQ29uc3RydWN0RmFjdG9yeSxcbiAgQ29uc3RydWN0RmFjdG9yeUdldEluc3RhbmNlUHJvcHMsXG4gIEZ1bmN0aW9uUmVzb3VyY2VzLFxuICBHZW5lcmF0ZUNvbnRhaW5lckVudHJ5UHJvcHMsXG4gIFJlc291cmNlQWNjZXNzQWNjZXB0b3JGYWN0b3J5LFxuICBSZXNvdXJjZU5hbWVWYWxpZGF0b3IsXG4gIFJlc291cmNlUHJvdmlkZXIsXG4gIFNzbUVudmlyb25tZW50RW50cnksXG4gIFN0YWNrUHJvdmlkZXIsXG59IGZyb20gJ0Bhd3MtYW1wbGlmeS9wbHVnaW4tdHlwZXMnO1xuaW1wb3J0IHsgQ29uc3RydWN0IH0gZnJvbSAnY29uc3RydWN0cyc7XG5pbXBvcnQgeyBOb2RlanNGdW5jdGlvbiwgT3V0cHV0Rm9ybWF0IH0gZnJvbSAnYXdzLWNkay1saWIvYXdzLWxhbWJkYS1ub2RlanMnO1xuaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7IER1cmF0aW9uLCBTdGFjaywgVGFncyB9IGZyb20gJ2F3cy1jZGstbGliJztcbmltcG9ydCB7IENmbkZ1bmN0aW9uLCBSdW50aW1lIH0gZnJvbSAnYXdzLWNkay1saWIvYXdzLWxhbWJkYSc7XG5pbXBvcnQgeyBjcmVhdGVSZXF1aXJlIH0gZnJvbSAnbW9kdWxlJztcbmltcG9ydCB7IEZ1bmN0aW9uRW52aXJvbm1lbnRUcmFuc2xhdG9yIH0gZnJvbSAnLi9mdW5jdGlvbl9lbnZfdHJhbnNsYXRvci5qcyc7XG5pbXBvcnQgeyBQb2xpY3kgfSBmcm9tICdhd3MtY2RrLWxpYi9hd3MtaWFtJztcbmltcG9ydCB7IHJlYWRGaWxlU3luYyB9IGZyb20gJ2ZzJztcbmltcG9ydCB7IEVPTCB9IGZyb20gJ29zJztcbmltcG9ydCB7XG4gIEZ1bmN0aW9uT3V0cHV0LFxuICBmdW5jdGlvbk91dHB1dEtleSxcbn0gZnJvbSAnQGF3cy1hbXBsaWZ5L2JhY2tlbmQtb3V0cHV0LXNjaGVtYXMnO1xuaW1wb3J0IHsgRnVuY3Rpb25FbnZpcm9ubWVudFR5cGVHZW5lcmF0b3IgfSBmcm9tICcuL2Z1bmN0aW9uX2Vudl90eXBlX2dlbmVyYXRvci5qcyc7XG5pbXBvcnQgeyBBdHRyaWJ1dGlvbk1ldGFkYXRhU3RvcmFnZSB9IGZyb20gJ0Bhd3MtYW1wbGlmeS9iYWNrZW5kLW91dHB1dC1zdG9yYWdlJztcbmltcG9ydCB7IGZpbGVVUkxUb1BhdGggfSBmcm9tICdub2RlOnVybCc7XG5pbXBvcnQge1xuICBBbXBsaWZ5VXNlckVycm9yLFxuICBDYWxsZXJEaXJlY3RvcnlFeHRyYWN0b3IsXG4gIFRhZ05hbWUsXG59IGZyb20gJ0Bhd3MtYW1wbGlmeS9wbGF0Zm9ybS1jb3JlJztcbmltcG9ydCB7IGNvbnZlcnRGdW5jdGlvblNjaGVkdWxlc1RvUnVsZVNjaGVkdWxlcyB9IGZyb20gJy4vc2NoZWR1bGVfcGFyc2VyLmpzJztcbmltcG9ydCAqIGFzIHRhcmdldHMgZnJvbSAnYXdzLWNkay1saWIvYXdzLWV2ZW50cy10YXJnZXRzJztcbmltcG9ydCB7IFJ1bGUgfSBmcm9tICdhd3MtY2RrLWxpYi9hd3MtZXZlbnRzJztcblxuY29uc3QgZnVuY3Rpb25TdGFja1R5cGUgPSAnZnVuY3Rpb24tTGFtYmRhJztcblxuZXhwb3J0IHR5cGUgQWRkRW52aXJvbm1lbnRGYWN0b3J5ID0ge1xuICBhZGRFbnZpcm9ubWVudDogKGtleTogc3RyaW5nLCB2YWx1ZTogc3RyaW5nIHwgQmFja2VuZFNlY3JldCkgPT4gdm9pZDtcbn07XG5cbmV4cG9ydCB0eXBlIENyb25TY2hlZHVsZSA9XG4gIHwgYCR7c3RyaW5nfSAke3N0cmluZ30gJHtzdHJpbmd9ICR7c3RyaW5nfSAke3N0cmluZ31gXG4gIHwgYCR7c3RyaW5nfSAke3N0cmluZ30gJHtzdHJpbmd9ICR7c3RyaW5nfSAke3N0cmluZ30gJHtzdHJpbmd9YDtcbmV4cG9ydCB0eXBlIFRpbWVJbnRlcnZhbCA9XG4gIHwgYGV2ZXJ5ICR7bnVtYmVyfW1gXG4gIHwgYGV2ZXJ5ICR7bnVtYmVyfWhgXG4gIHwgYGV2ZXJ5IGRheWBcbiAgfCBgZXZlcnkgd2Vla2BcbiAgfCBgZXZlcnkgbW9udGhgXG4gIHwgYGV2ZXJ5IHllYXJgO1xuZXhwb3J0IHR5cGUgRnVuY3Rpb25TY2hlZHVsZSA9IFRpbWVJbnRlcnZhbCB8IENyb25TY2hlZHVsZTtcblxuLyoqXG4gKiBFbnRyeSBwb2ludCBmb3IgZGVmaW5pbmcgYSBmdW5jdGlvbiBpbiB0aGUgQW1wbGlmeSBlY29zeXN0ZW1cbiAqL1xuZXhwb3J0IGNvbnN0IGRlZmluZUZ1bmN0aW9uID0gKFxuICBwcm9wczogRnVuY3Rpb25Qcm9wcyA9IHt9XG4pOiBDb25zdHJ1Y3RGYWN0b3J5PFxuICBSZXNvdXJjZVByb3ZpZGVyPEZ1bmN0aW9uUmVzb3VyY2VzPiAmXG4gICAgUmVzb3VyY2VBY2Nlc3NBY2NlcHRvckZhY3RvcnkgJlxuICAgIEFkZEVudmlyb25tZW50RmFjdG9yeSAmXG4gICAgU3RhY2tQcm92aWRlclxuPiA9PiBuZXcgRnVuY3Rpb25GYWN0b3J5KHByb3BzLCBuZXcgRXJyb3IoKS5zdGFjayk7XG5cbmV4cG9ydCB0eXBlIEZ1bmN0aW9uUHJvcHMgPSB7XG4gIC8qKlxuICAgKiBBIG5hbWUgZm9yIHRoZSBmdW5jdGlvbi5cbiAgICogRGVmYXVsdHMgdG8gdGhlIGJhc2VuYW1lIG9mIHRoZSBlbnRyeSBwYXRoIGlmIHNwZWNpZmllZC5cbiAgICogSWYgbm8gZW50cnkgaXMgc3BlY2lmaWVkLCBkZWZhdWx0cyB0byB0aGUgZGlyZWN0b3J5IG5hbWUgaW4gd2hpY2ggdGhpcyBmdW5jdGlvbiBpcyBkZWZpbmVkLlxuICAgKlxuICAgKiBFeGFtcGxlOlxuICAgKiBJZiBlbnRyeSBpcyBgLi9zY2hlZHVsZWQtZGItYmFja3VwLnRzYCB0aGUgbmFtZSB3aWxsIGRlZmF1bHQgdG8gXCJzY2hlZHVsZWQtZGItYmFja3VwXCJcbiAgICogSWYgZW50cnkgaXMgbm90IHNldCBhbmQgdGhlIGZ1bmN0aW9uIGlzIGRlZmluZWQgaW4gYGFtcGxpZnkvZnVuY3Rpb25zL2RiLWJhY2t1cC9yZXNvdXJjZS50c2AgdGhlIG5hbWUgd2lsbCBkZWZhdWx0IHRvIFwiZGItYmFja3VwXCJcbiAgICovXG4gIG5hbWU/OiBzdHJpbmc7XG4gIC8qKlxuICAgKiBUaGUgcGF0aCB0byB0aGUgZmlsZSB0aGF0IGNvbnRhaW5zIHRoZSBmdW5jdGlvbiBlbnRyeSBwb2ludC5cbiAgICogSWYgdGhpcyBpcyBhIHJlbGF0aXZlIHBhdGgsIGl0IGlzIGNvbXB1dGVkIHJlbGF0aXZlIHRvIHRoZSBmaWxlIHdoZXJlIHRoaXMgZnVuY3Rpb24gaXMgZGVmaW5lZFxuICAgKlxuICAgKiBEZWZhdWx0cyB0byAnLi9oYW5kbGVyLnRzJ1xuICAgKi9cbiAgZW50cnk/OiBzdHJpbmc7XG5cbiAgLyoqXG4gICAqIEFuIGFtb3VudCBvZiB0aW1lIGluIHNlY29uZHMgYmV0d2VlbiAxIHNlY29uZCBhbmQgMTUgbWludXRlcy5cbiAgICogTXVzdCBiZSBhIHdob2xlIG51bWJlci5cbiAgICogRGVmYXVsdCBpcyAzIHNlY29uZHMuXG4gICAqL1xuICB0aW1lb3V0U2Vjb25kcz86IG51bWJlcjtcblxuICAvKipcbiAgICogQW4gYW1vdW50IG9mIG1lbW9yeSAoUkFNKSB0byBhbGxvY2F0ZSB0byB0aGUgZnVuY3Rpb24gYmV0d2VlbiAxMjggYW5kIDEwMjQwIE1CLlxuICAgKiBNdXN0IGJlIGEgd2hvbGUgbnVtYmVyLlxuICAgKiBEZWZhdWx0IGlzIDEyOE1CLlxuICAgKi9cbiAgbWVtb3J5TUI/OiBudW1iZXI7XG5cbiAgLyoqXG4gICAqIEVudmlyb25tZW50IHZhcmlhYmxlcyB0aGF0IHdpbGwgYmUgYXZhaWxhYmxlIGR1cmluZyBmdW5jdGlvbiBleGVjdXRpb25cbiAgICovXG4gIGVudmlyb25tZW50PzogUmVjb3JkPHN0cmluZywgc3RyaW5nIHwgQmFja2VuZFNlY3JldD47XG5cbiAgLyoqXG4gICAqIE5vZGUgcnVudGltZSB2ZXJzaW9uIGZvciB0aGUgbGFtYmRhIGVudmlyb25tZW50LlxuICAgKlxuICAgKiBEZWZhdWx0cyB0byB0aGUgb2xkZXN0IE5vZGVKUyBMVFMgdmVyc2lvbi4gU2VlIGh0dHBzOi8vbm9kZWpzLm9yZy9lbi9hYm91dC9wcmV2aW91cy1yZWxlYXNlc1xuICAgKi9cbiAgcnVudGltZT86IE5vZGVWZXJzaW9uO1xuXG4gIC8qKlxuICAgKiBBIHRpbWUgaW50ZXJ2YWwgc3RyaW5nIHRvIHBlcmlvZGljYWxseSBydW4gdGhlIGZ1bmN0aW9uLlxuICAgKiBUaGlzIGNhbiBiZSBlaXRoZXIgYSBzdHJpbmcgb2YgYFwiZXZlcnkgPHBvc2l0aXZlIHdob2xlIG51bWJlcj48bSAobWludXRlKSBvciBoIChob3VyKT5cImAsIGBcImV2ZXJ5IGRheXx3ZWVrfG1vbnRofHllYXJcImAgb3IgY3JvbiBleHByZXNzaW9uLlxuICAgKiBEZWZhdWx0cyB0byBubyBzY2hlZHVsaW5nIGZvciB0aGUgZnVuY3Rpb24uXG4gICAqIEBleGFtcGxlXG4gICAqIHNjaGVkdWxlOiBcImV2ZXJ5IDVtXCJcbiAgICogQGV4YW1wbGVcbiAgICogc2NoZWR1bGU6IFwiZXZlcnkgd2Vla1wiXG4gICAqIEBleGFtcGxlXG4gICAqIHNjaGVkdWxlOiBcIjAgOSA/ICogMiAqXCIgLy8gZXZlcnkgTW9uZGF5IGF0IDlhbVxuICAgKi9cbiAgc2NoZWR1bGU/OiBGdW5jdGlvblNjaGVkdWxlIHwgRnVuY3Rpb25TY2hlZHVsZVtdO1xufTtcblxuLyoqXG4gKiBDcmVhdGUgTGFtYmRhIGZ1bmN0aW9ucyBpbiB0aGUgY29udGV4dCBvZiBhbiBBbXBsaWZ5IGJhY2tlbmQgZGVmaW5pdGlvblxuICovXG5jbGFzcyBGdW5jdGlvbkZhY3RvcnkgaW1wbGVtZW50cyBDb25zdHJ1Y3RGYWN0b3J5PEFtcGxpZnlGdW5jdGlvbj4ge1xuICBwcml2YXRlIGdlbmVyYXRvcjogQ29uc3RydWN0Q29udGFpbmVyRW50cnlHZW5lcmF0b3I7XG4gIC8qKlxuICAgKiBDcmVhdGUgYSBuZXcgQW1wbGlmeUZ1bmN0aW9uRmFjdG9yeVxuICAgKi9cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSByZWFkb25seSBwcm9wczogRnVuY3Rpb25Qcm9wcyxcbiAgICBwcml2YXRlIHJlYWRvbmx5IGNhbGxlclN0YWNrPzogc3RyaW5nXG4gICkge31cblxuICAvKipcbiAgICogQ3JlYXRlcyBhbiBpbnN0YW5jZSBvZiBBbXBsaWZ5RnVuY3Rpb24gd2l0aGluIHRoZSBwcm92aWRlZCBBbXBsaWZ5IGNvbnRleHRcbiAgICovXG4gIGdldEluc3RhbmNlID0gKHtcbiAgICBjb25zdHJ1Y3RDb250YWluZXIsXG4gICAgb3V0cHV0U3RvcmFnZVN0cmF0ZWd5LFxuICAgIHJlc291cmNlTmFtZVZhbGlkYXRvcixcbiAgfTogQ29uc3RydWN0RmFjdG9yeUdldEluc3RhbmNlUHJvcHMpOiBBbXBsaWZ5RnVuY3Rpb24gPT4ge1xuICAgIGlmICghdGhpcy5nZW5lcmF0b3IpIHtcbiAgICAgIHRoaXMuZ2VuZXJhdG9yID0gbmV3IEZ1bmN0aW9uR2VuZXJhdG9yKFxuICAgICAgICB0aGlzLmh5ZHJhdGVEZWZhdWx0cyhyZXNvdXJjZU5hbWVWYWxpZGF0b3IpLFxuICAgICAgICBvdXRwdXRTdG9yYWdlU3RyYXRlZ3lcbiAgICAgICk7XG4gICAgfVxuICAgIHJldHVybiBjb25zdHJ1Y3RDb250YWluZXIuZ2V0T3JDb21wdXRlKHRoaXMuZ2VuZXJhdG9yKSBhcyBBbXBsaWZ5RnVuY3Rpb247XG4gIH07XG5cbiAgcHJpdmF0ZSBoeWRyYXRlRGVmYXVsdHMgPSAoXG4gICAgcmVzb3VyY2VOYW1lVmFsaWRhdG9yPzogUmVzb3VyY2VOYW1lVmFsaWRhdG9yXG4gICk6IEh5ZHJhdGVkRnVuY3Rpb25Qcm9wcyA9PiB7XG4gICAgY29uc3QgbmFtZSA9IHRoaXMucmVzb2x2ZU5hbWUoKTtcbiAgICByZXNvdXJjZU5hbWVWYWxpZGF0b3I/LnZhbGlkYXRlKG5hbWUpO1xuICAgIHJldHVybiB7XG4gICAgICBuYW1lLFxuICAgICAgZW50cnk6IHRoaXMucmVzb2x2ZUVudHJ5KCksXG4gICAgICB0aW1lb3V0U2Vjb25kczogdGhpcy5yZXNvbHZlVGltZW91dCgpLFxuICAgICAgbWVtb3J5TUI6IHRoaXMucmVzb2x2ZU1lbW9yeSgpLFxuICAgICAgZW52aXJvbm1lbnQ6IHRoaXMucHJvcHMuZW52aXJvbm1lbnQgPz8ge30sXG4gICAgICBydW50aW1lOiB0aGlzLnJlc29sdmVSdW50aW1lKCksXG4gICAgICBzY2hlZHVsZTogdGhpcy5yZXNvbHZlU2NoZWR1bGUoKSxcbiAgICB9O1xuICB9O1xuXG4gIHByaXZhdGUgcmVzb2x2ZU5hbWUgPSAoKSA9PiB7XG4gICAgLy8gSWYgbmFtZSBpcyBzZXQgZXhwbGljaXRseSwgdXNlIHRoYXRcbiAgICBpZiAodGhpcy5wcm9wcy5uYW1lKSB7XG4gICAgICByZXR1cm4gdGhpcy5wcm9wcy5uYW1lO1xuICAgIH1cbiAgICAvLyBJZiBlbnRyeSBpcyBzZXQsIHVzZSB0aGUgYmFzZW5hbWUgb2YgdGhlIGVudHJ5IHBhdGhcbiAgICBpZiAodGhpcy5wcm9wcy5lbnRyeSkge1xuICAgICAgcmV0dXJuIHBhdGgucGFyc2UodGhpcy5wcm9wcy5lbnRyeSkubmFtZTtcbiAgICB9XG5cbiAgICAvLyBPdGhlcndpc2UsIHVzZSB0aGUgZGlyZWN0b3J5IG5hbWUgd2hlcmUgdGhlIGZ1bmN0aW9uIGlzIGRlZmluZWRcbiAgICByZXR1cm4gcGF0aC5iYXNlbmFtZShcbiAgICAgIG5ldyBDYWxsZXJEaXJlY3RvcnlFeHRyYWN0b3IodGhpcy5jYWxsZXJTdGFjaykuZXh0cmFjdCgpXG4gICAgKTtcbiAgfTtcblxuICBwcml2YXRlIHJlc29sdmVFbnRyeSA9ICgpID0+IHtcbiAgICAvLyBpZiBlbnRyeSBpcyBub3Qgc2V0LCBkZWZhdWx0IHRvIGhhbmRsZXIudHNcbiAgICBpZiAoIXRoaXMucHJvcHMuZW50cnkpIHtcbiAgICAgIHJldHVybiBwYXRoLmpvaW4oXG4gICAgICAgIG5ldyBDYWxsZXJEaXJlY3RvcnlFeHRyYWN0b3IodGhpcy5jYWxsZXJTdGFjaykuZXh0cmFjdCgpLFxuICAgICAgICAnaGFuZGxlci50cydcbiAgICAgICk7XG4gICAgfVxuXG4gICAgLy8gaWYgZW50cnkgaXMgYWJzb2x1dGUgdXNlIHRoYXRcbiAgICBpZiAocGF0aC5pc0Fic29sdXRlKHRoaXMucHJvcHMuZW50cnkpKSB7XG4gICAgICByZXR1cm4gdGhpcy5wcm9wcy5lbnRyeTtcbiAgICB9XG5cbiAgICAvLyBpZiBlbnRyeSBpcyByZWxhdGl2ZSwgY29tcHV0ZSB3aXRoIHJlc3BlY3QgdG8gdGhlIGNhbGxlciBkaXJlY3RvcnlcbiAgICByZXR1cm4gcGF0aC5qb2luKFxuICAgICAgbmV3IENhbGxlckRpcmVjdG9yeUV4dHJhY3Rvcih0aGlzLmNhbGxlclN0YWNrKS5leHRyYWN0KCksXG4gICAgICB0aGlzLnByb3BzLmVudHJ5XG4gICAgKTtcbiAgfTtcblxuICBwcml2YXRlIHJlc29sdmVUaW1lb3V0ID0gKCkgPT4ge1xuICAgIGNvbnN0IHRpbWVvdXRNaW4gPSAxO1xuICAgIGNvbnN0IHRpbWVvdXRNYXggPSA2MCAqIDE1OyAvLyAxNSBtaW51dGVzIGluIHNlY29uZHNcbiAgICBjb25zdCB0aW1lb3V0RGVmYXVsdCA9IDM7XG4gICAgaWYgKHRoaXMucHJvcHMudGltZW91dFNlY29uZHMgPT09IHVuZGVmaW5lZCkge1xuICAgICAgcmV0dXJuIHRpbWVvdXREZWZhdWx0O1xuICAgIH1cblxuICAgIGlmIChcbiAgICAgICFpc1dob2xlTnVtYmVyQmV0d2VlbkluY2x1c2l2ZShcbiAgICAgICAgdGhpcy5wcm9wcy50aW1lb3V0U2Vjb25kcyxcbiAgICAgICAgdGltZW91dE1pbixcbiAgICAgICAgdGltZW91dE1heFxuICAgICAgKVxuICAgICkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgdGltZW91dFNlY29uZHMgbXVzdCBiZSBhIHdob2xlIG51bWJlciBiZXR3ZWVuICR7dGltZW91dE1pbn0gYW5kICR7dGltZW91dE1heH0gaW5jbHVzaXZlYFxuICAgICAgKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMucHJvcHMudGltZW91dFNlY29uZHM7XG4gIH07XG5cbiAgcHJpdmF0ZSByZXNvbHZlTWVtb3J5ID0gKCkgPT4ge1xuICAgIGNvbnN0IG1lbW9yeU1pbiA9IDEyODtcbiAgICBjb25zdCBtZW1vcnlNYXggPSAxMDI0MDtcbiAgICBjb25zdCBtZW1vcnlEZWZhdWx0ID0gNTEyO1xuICAgIGlmICh0aGlzLnByb3BzLm1lbW9yeU1CID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHJldHVybiBtZW1vcnlEZWZhdWx0O1xuICAgIH1cbiAgICBpZiAoXG4gICAgICAhaXNXaG9sZU51bWJlckJldHdlZW5JbmNsdXNpdmUodGhpcy5wcm9wcy5tZW1vcnlNQiwgbWVtb3J5TWluLCBtZW1vcnlNYXgpXG4gICAgKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBtZW1vcnlNQiBtdXN0IGJlIGEgd2hvbGUgbnVtYmVyIGJldHdlZW4gJHttZW1vcnlNaW59IGFuZCAke21lbW9yeU1heH0gaW5jbHVzaXZlYFxuICAgICAgKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMucHJvcHMubWVtb3J5TUI7XG4gIH07XG5cbiAgcHJpdmF0ZSByZXNvbHZlUnVudGltZSA9ICgpID0+IHtcbiAgICBjb25zdCBydW50aW1lRGVmYXVsdCA9IDE4O1xuXG4gICAgLy8gaWYgcnVudGltZSBpcyBub3Qgc2V0LCBkZWZhdWx0IHRvIHRoZSBvbGRlc3QgTFRTXG4gICAgaWYgKCF0aGlzLnByb3BzLnJ1bnRpbWUpIHtcbiAgICAgIHJldHVybiBydW50aW1lRGVmYXVsdDtcbiAgICB9XG5cbiAgICBpZiAoISh0aGlzLnByb3BzLnJ1bnRpbWUgaW4gbm9kZVZlcnNpb25NYXApKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBydW50aW1lIG11c3QgYmUgb25lIG9mIHRoZSBmb2xsb3dpbmc6ICR7T2JqZWN0LmtleXMoXG4gICAgICAgICAgbm9kZVZlcnNpb25NYXBcbiAgICAgICAgKS5qb2luKCcsICcpfWBcbiAgICAgICk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXMucHJvcHMucnVudGltZTtcbiAgfTtcblxuICBwcml2YXRlIHJlc29sdmVTY2hlZHVsZSA9ICgpID0+IHtcbiAgICBpZiAoIXRoaXMucHJvcHMuc2NoZWR1bGUpIHtcbiAgICAgIHJldHVybiBbXTtcbiAgICB9XG5cbiAgICByZXR1cm4gdGhpcy5wcm9wcy5zY2hlZHVsZTtcbiAgfTtcbn1cblxudHlwZSBIeWRyYXRlZEZ1bmN0aW9uUHJvcHMgPSBSZXF1aXJlZDxGdW5jdGlvblByb3BzPjtcblxuY2xhc3MgRnVuY3Rpb25HZW5lcmF0b3IgaW1wbGVtZW50cyBDb25zdHJ1Y3RDb250YWluZXJFbnRyeUdlbmVyYXRvciB7XG4gIHJlYWRvbmx5IHJlc291cmNlR3JvdXBOYW1lID0gJ2Z1bmN0aW9uJztcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHJlYWRvbmx5IHByb3BzOiBIeWRyYXRlZEZ1bmN0aW9uUHJvcHMsXG4gICAgcHJpdmF0ZSByZWFkb25seSBvdXRwdXRTdG9yYWdlU3RyYXRlZ3k6IEJhY2tlbmRPdXRwdXRTdG9yYWdlU3RyYXRlZ3k8RnVuY3Rpb25PdXRwdXQ+XG4gICkge31cblxuICBnZW5lcmF0ZUNvbnRhaW5lckVudHJ5ID0gKHtcbiAgICBzY29wZSxcbiAgICBiYWNrZW5kU2VjcmV0UmVzb2x2ZXIsXG4gIH06IEdlbmVyYXRlQ29udGFpbmVyRW50cnlQcm9wcykgPT4ge1xuICAgIHJldHVybiBuZXcgQW1wbGlmeUZ1bmN0aW9uKFxuICAgICAgc2NvcGUsXG4gICAgICB0aGlzLnByb3BzLm5hbWUsXG4gICAgICB0aGlzLnByb3BzLFxuICAgICAgYmFja2VuZFNlY3JldFJlc29sdmVyLFxuICAgICAgdGhpcy5vdXRwdXRTdG9yYWdlU3RyYXRlZ3lcbiAgICApO1xuICB9O1xufVxuXG5jbGFzcyBBbXBsaWZ5RnVuY3Rpb25cbiAgZXh0ZW5kcyBDb25zdHJ1Y3RcbiAgaW1wbGVtZW50c1xuICAgIFJlc291cmNlUHJvdmlkZXI8RnVuY3Rpb25SZXNvdXJjZXM+LFxuICAgIFJlc291cmNlQWNjZXNzQWNjZXB0b3JGYWN0b3J5LFxuICAgIEFkZEVudmlyb25tZW50RmFjdG9yeVxue1xuICByZWFkb25seSByZXNvdXJjZXM6IEZ1bmN0aW9uUmVzb3VyY2VzO1xuICByZWFkb25seSBzdGFjazogU3RhY2s7XG4gIHByaXZhdGUgcmVhZG9ubHkgZnVuY3Rpb25FbnZpcm9ubWVudFRyYW5zbGF0b3I6IEZ1bmN0aW9uRW52aXJvbm1lbnRUcmFuc2xhdG9yO1xuICBjb25zdHJ1Y3RvcihcbiAgICBzY29wZTogQ29uc3RydWN0LFxuICAgIGlkOiBzdHJpbmcsXG4gICAgcHJvcHM6IEh5ZHJhdGVkRnVuY3Rpb25Qcm9wcyxcbiAgICBiYWNrZW5kU2VjcmV0UmVzb2x2ZXI6IEJhY2tlbmRTZWNyZXRSZXNvbHZlcixcbiAgICBvdXRwdXRTdG9yYWdlU3RyYXRlZ3k6IEJhY2tlbmRPdXRwdXRTdG9yYWdlU3RyYXRlZ3k8RnVuY3Rpb25PdXRwdXQ+XG4gICkge1xuICAgIHN1cGVyKHNjb3BlLCBpZCk7XG5cbiAgICB0aGlzLnN0YWNrID0gU3RhY2sub2Yoc2NvcGUpO1xuXG4gICAgY29uc3QgcnVudGltZSA9IG5vZGVWZXJzaW9uTWFwW3Byb3BzLnJ1bnRpbWVdO1xuXG4gICAgY29uc3QgcmVxdWlyZSA9IGNyZWF0ZVJlcXVpcmUoaW1wb3J0Lm1ldGEudXJsKTtcblxuICAgIGNvbnN0IHNoaW1zID1cbiAgICAgIHJ1bnRpbWUgPT09IFJ1bnRpbWUuTk9ERUpTXzE2X1hcbiAgICAgICAgPyBbXVxuICAgICAgICA6IFtyZXF1aXJlLnJlc29sdmUoJy4vbGFtYmRhLXNoaW1zL2Nqc19zaGltJyldO1xuXG4gICAgY29uc3Qgc3NtUmVzb2x2ZXJGaWxlID1cbiAgICAgIHJ1bnRpbWUgPT09IFJ1bnRpbWUuTk9ERUpTXzE2X1hcbiAgICAgICAgPyByZXF1aXJlLnJlc29sdmUoJy4vbGFtYmRhLXNoaW1zL3Jlc29sdmVfc3NtX3BhcmFtc19zZGtfdjInKSAvLyB1c2UgYXdzIGNkayB2MiBpbiBub2RlIDE2XG4gICAgICAgIDogcmVxdWlyZS5yZXNvbHZlKCcuL2xhbWJkYS1zaGltcy9yZXNvbHZlX3NzbV9wYXJhbXMnKTtcblxuICAgIGNvbnN0IGludm9rZVNzbVJlc29sdmVyRmlsZSA9IHJlcXVpcmUucmVzb2x2ZShcbiAgICAgICcuL2xhbWJkYS1zaGltcy9pbnZva2Vfc3NtX3NoaW0nXG4gICAgKTtcblxuICAgIC8qKlxuICAgICAqIFRoaXMgY29kZSBjb25jYXRlbmF0ZXMgdGhlIGNvbnRlbnRzIG9mIHRoZSBzc20gcmVzb2x2ZXIgYW5kIGludm9rZXIgaW50byBhIHNpbmdsZSBsaW5lIHRoYXQgY2FuIGJlIHVzZWQgYXMgdGhlIGVzYnVpbGQgYmFubmVyIGNvbnRlbnRcbiAgICAgKiBUaGlzIGJhbm5lciBpcyByZXNwb25zaWJsZSBmb3IgcmVzb2x2aW5nIHRoZSBjdXN0b21lcidzIFNTTSBwYXJhbWV0ZXJzIGF0IHJ1bnRpbWVcbiAgICAgKi9cbiAgICBjb25zdCBiYW5uZXJDb2RlID0gcmVhZEZpbGVTeW5jKHNzbVJlc29sdmVyRmlsZSwgJ3V0Zi04JylcbiAgICAgIC5jb25jYXQocmVhZEZpbGVTeW5jKGludm9rZVNzbVJlc29sdmVyRmlsZSwgJ3V0Zi04JykpXG4gICAgICAuc3BsaXQobmV3IFJlZ0V4cChgJHtFT0x9fFxcbnxcXHJgLCAnZycpKVxuICAgICAgLm1hcCgobGluZSkgPT4gbGluZS5yZXBsYWNlKC9cXC9cXC8uKiQvLCAnJykpIC8vIHN0cmlwIG91dCBpbmxpbmUgY29tbWVudHMgYmVjYXVzZSB0aGUgYmFubmVyIGlzIGdvaW5nIHRvIGJlIGZsYXR0ZW5lZCBpbnRvIGEgc2luZ2xlIGxpbmVcbiAgICAgIC5qb2luKCcnKTtcblxuICAgIGNvbnN0IGZ1bmN0aW9uRW52aXJvbm1lbnRUeXBlR2VuZXJhdG9yID1cbiAgICAgIG5ldyBGdW5jdGlvbkVudmlyb25tZW50VHlwZUdlbmVyYXRvcihpZCk7XG5cbiAgICAvLyBlc2J1aWxkIHJ1bnMgYXMgcGFydCBvZiB0aGUgTm9kZWpzRnVuY3Rpb24gY29uc3RydWN0b3IsIHNvIHdlIGVhZ2VybHkgZ2VuZXJhdGUgdGhlIHByb2Nlc3MgZW52IHNoaW0gd2l0aG91dCB0eXBlcyBzbyBpdCBjYW4gYmUgaW5jbHVkZWQgaW4gdGhlIGZ1bmN0aW9uIGJ1bmRsZS5cbiAgICAvLyBUaGlzIHdpbGwgYmUgb3ZlcndyaXR0ZW4gd2l0aCB0aGUgdHlwZWQgZmlsZSBhdCB0aGUgZW5kIG9mIHN5bnRoZXNpc1xuICAgIGZ1bmN0aW9uRW52aXJvbm1lbnRUeXBlR2VuZXJhdG9yLmdlbmVyYXRlUHJvY2Vzc0VudlNoaW0oKTtcblxuICAgIGxldCBmdW5jdGlvbkxhbWJkYTogTm9kZWpzRnVuY3Rpb247XG4gICAgdHJ5IHtcbiAgICAgIGZ1bmN0aW9uTGFtYmRhID0gbmV3IE5vZGVqc0Z1bmN0aW9uKHNjb3BlLCBgJHtpZH0tbGFtYmRhYCwge1xuICAgICAgICBlbnRyeTogcHJvcHMuZW50cnksXG4gICAgICAgIHRpbWVvdXQ6IER1cmF0aW9uLnNlY29uZHMocHJvcHMudGltZW91dFNlY29uZHMpLFxuICAgICAgICBtZW1vcnlTaXplOiBwcm9wcy5tZW1vcnlNQixcbiAgICAgICAgcnVudGltZTogbm9kZVZlcnNpb25NYXBbcHJvcHMucnVudGltZV0sXG4gICAgICAgIGJ1bmRsaW5nOiB7XG4gICAgICAgICAgZm9ybWF0OiBPdXRwdXRGb3JtYXQuRVNNLFxuICAgICAgICAgIGJhbm5lcjogYmFubmVyQ29kZSxcbiAgICAgICAgICBidW5kbGVBd3NTREs6IHRydWUsXG4gICAgICAgICAgaW5qZWN0OiBzaGltcyxcbiAgICAgICAgICBsb2FkZXI6IHtcbiAgICAgICAgICAgICcubm9kZSc6ICdmaWxlJyxcbiAgICAgICAgICB9LFxuICAgICAgICAgIG1pbmlmeTogdHJ1ZSxcbiAgICAgICAgICBzb3VyY2VNYXA6IHRydWUsXG4gICAgICAgIH0sXG4gICAgICB9KTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgLy8gSWYgdGhlIGVycm9yIGlzIGZyb20gRVMgQnVuZGxlciB3aGljaCBpcyBleGVjdXRlZCBhcyBhIGNoaWxkIHByb2Nlc3MgYnkgQ0RLLFxuICAgICAgLy8gdGhlbiB0aGUgZXJyb3IgZnJvbSBDREsgY29udGFpbnMgdGhlIGNvbW1hbmQgdGhhdCB3YXMgZXhlY3V0ZWQgYWxvbmcgd2l0aCB0aGUgZXhpdCBzdGF0dXMuXG4gICAgICAvLyBXcmFwcGluZyBpdCBoZXJlICB3b3VsZCBjYXVzZSB0aGUgY2RrX2RlcGxveWVyIHRvIHJlLXRocm93IHRoaXMgd3JhcHBlZCBleGNlcHRpb25cbiAgICAgIC8vIGluc3RlYWQgb2Ygc2NyYXBpbmcgdGhlIHN0ZGVyciBmb3IgYWN0dWFsIEVTQnVpbGQgZXJyb3IuXG4gICAgICBpZiAoXG4gICAgICAgIGVycm9yIGluc3RhbmNlb2YgRXJyb3IgJiZcbiAgICAgICAgZXJyb3IubWVzc2FnZS5tYXRjaCgvRmFpbGVkIHRvIGJ1bmRsZSBhc3NldC4qZXhpdGVkIHdpdGggc3RhdHVzLylcbiAgICAgICkge1xuICAgICAgICB0aHJvdyBlcnJvcjtcbiAgICAgIH1cbiAgICAgIHRocm93IG5ldyBBbXBsaWZ5VXNlckVycm9yKFxuICAgICAgICAnTm9kZUpTRnVuY3Rpb25Db25zdHJ1Y3RJbml0aWFsaXphdGlvbkVycm9yJyxcbiAgICAgICAge1xuICAgICAgICAgIG1lc3NhZ2U6ICdGYWlsZWQgdG8gaW5zdGFudGlhdGUgbm9kZWpzIGZ1bmN0aW9uIGNvbnN0cnVjdCcsXG4gICAgICAgICAgcmVzb2x1dGlvbjpcbiAgICAgICAgICAgICdTZWUgdGhlIHVuZGVybHlpbmcgZXJyb3IgbWVzc2FnZSBmb3IgbW9yZSBkZXRhaWxzLiBVc2UgYC0tZGVidWdgIGZvciBhZGRpdGlvbmFsIGRlYnVnZ2luZyBpbmZvcm1hdGlvbi4nLFxuICAgICAgICB9LFxuICAgICAgICBlcnJvciBhcyBFcnJvclxuICAgICAgKTtcbiAgICB9XG5cbiAgICB0cnkge1xuICAgICAgY29uc3Qgc2NoZWR1bGVzID0gY29udmVydEZ1bmN0aW9uU2NoZWR1bGVzVG9SdWxlU2NoZWR1bGVzKFxuICAgICAgICBmdW5jdGlvbkxhbWJkYSxcbiAgICAgICAgcHJvcHMuc2NoZWR1bGVcbiAgICAgICk7XG4gICAgICBjb25zdCBsYW1iZGFUYXJnZXQgPSBuZXcgdGFyZ2V0cy5MYW1iZGFGdW5jdGlvbihmdW5jdGlvbkxhbWJkYSk7XG5cbiAgICAgIHNjaGVkdWxlcy5mb3JFYWNoKChzY2hlZHVsZSwgaW5kZXgpID0+IHtcbiAgICAgICAgLy8gTGFtYmRhIG5hbWUgd2lsbCBiZSBwcmVwZW5kZWQgdG8gcnVsZSBpZCwgc28gb25seSB1c2luZyBpbmRleCBoZXJlIGZvciB1bmlxdWVuZXNzXG4gICAgICAgIGNvbnN0IHJ1bGUgPSBuZXcgUnVsZShmdW5jdGlvbkxhbWJkYSwgYHNjaGVkdWxlJHtpbmRleH1gLCB7XG4gICAgICAgICAgc2NoZWR1bGUsXG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJ1bGUuYWRkVGFyZ2V0KGxhbWJkYVRhcmdldCk7XG4gICAgICB9KTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhyb3cgbmV3IEFtcGxpZnlVc2VyRXJyb3IoXG4gICAgICAgICdGdW5jdGlvblNjaGVkdWxlSW5pdGlhbGl6YXRpb25FcnJvcicsXG4gICAgICAgIHtcbiAgICAgICAgICBtZXNzYWdlOiAnRmFpbGVkIHRvIGluc3RhbnRpYXRlIHNjaGVkdWxlIGZvciBub2RlanMgZnVuY3Rpb24nLFxuICAgICAgICAgIHJlc29sdXRpb246ICdTZWUgdGhlIHVuZGVybHlpbmcgZXJyb3IgbWVzc2FnZSBmb3IgbW9yZSBkZXRhaWxzLicsXG4gICAgICAgIH0sXG4gICAgICAgIGVycm9yIGFzIEVycm9yXG4gICAgICApO1xuICAgIH1cblxuICAgIFRhZ3Mub2YoZnVuY3Rpb25MYW1iZGEpLmFkZChUYWdOYW1lLkZSSUVORExZX05BTUUsIGlkKTtcblxuICAgIHRoaXMuZnVuY3Rpb25FbnZpcm9ubWVudFRyYW5zbGF0b3IgPSBuZXcgRnVuY3Rpb25FbnZpcm9ubWVudFRyYW5zbGF0b3IoXG4gICAgICBmdW5jdGlvbkxhbWJkYSxcbiAgICAgIHByb3BzLmVudmlyb25tZW50LFxuICAgICAgYmFja2VuZFNlY3JldFJlc29sdmVyLFxuICAgICAgZnVuY3Rpb25FbnZpcm9ubWVudFR5cGVHZW5lcmF0b3JcbiAgICApO1xuXG4gICAgdGhpcy5yZXNvdXJjZXMgPSB7XG4gICAgICBsYW1iZGE6IGZ1bmN0aW9uTGFtYmRhLFxuICAgICAgY2ZuUmVzb3VyY2VzOiB7XG4gICAgICAgIGNmbkZ1bmN0aW9uOiBmdW5jdGlvbkxhbWJkYS5ub2RlLmZpbmRDaGlsZCgnUmVzb3VyY2UnKSBhcyBDZm5GdW5jdGlvbixcbiAgICAgIH0sXG4gICAgfTtcblxuICAgIHRoaXMuc3RvcmVPdXRwdXQob3V0cHV0U3RvcmFnZVN0cmF0ZWd5KTtcblxuICAgIG5ldyBBdHRyaWJ1dGlvbk1ldGFkYXRhU3RvcmFnZSgpLnN0b3JlQXR0cmlidXRpb25NZXRhZGF0YShcbiAgICAgIFN0YWNrLm9mKHRoaXMpLFxuICAgICAgZnVuY3Rpb25TdGFja1R5cGUsXG4gICAgICBmaWxlVVJMVG9QYXRoKG5ldyBVUkwoJy4uL3BhY2thZ2UuanNvbicsIGltcG9ydC5tZXRhLnVybCkpXG4gICAgKTtcbiAgfVxuXG4gIGFkZEVudmlyb25tZW50ID0gKGtleTogc3RyaW5nLCB2YWx1ZTogc3RyaW5nIHwgQmFja2VuZFNlY3JldCkgPT4ge1xuICAgIHRoaXMuZnVuY3Rpb25FbnZpcm9ubWVudFRyYW5zbGF0b3IuYWRkRW52aXJvbm1lbnRFbnRyeShrZXksIHZhbHVlKTtcbiAgfTtcblxuICBnZXRSZXNvdXJjZUFjY2Vzc0FjY2VwdG9yID0gKCkgPT4gKHtcbiAgICBpZGVudGlmaWVyOiBgJHt0aGlzLm5vZGUuaWR9TGFtYmRhUmVzb3VyY2VBY2Nlc3NBY2NlcHRvcmAsXG4gICAgYWNjZXB0UmVzb3VyY2VBY2Nlc3M6IChcbiAgICAgIHBvbGljeTogUG9saWN5LFxuICAgICAgc3NtRW52aXJvbm1lbnRFbnRyaWVzOiBTc21FbnZpcm9ubWVudEVudHJ5W11cbiAgICApID0+IHtcbiAgICAgIGNvbnN0IHJvbGUgPSB0aGlzLnJlc291cmNlcy5sYW1iZGEucm9sZTtcbiAgICAgIGlmICghcm9sZSkge1xuICAgICAgICAvLyBUaGlzIHNob3VsZCBuZXZlciBoYXBwZW4gc2luY2Ugd2UgYXJlIHVzaW5nIHRoZSBGdW5jdGlvbiBMMiBjb25zdHJ1Y3RcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgICdObyBleGVjdXRpb24gcm9sZSBmb3VuZCB0byBhdHRhY2ggbGFtYmRhIHBlcm1pc3Npb25zIHRvJ1xuICAgICAgICApO1xuICAgICAgfVxuICAgICAgcG9saWN5LmF0dGFjaFRvUm9sZShyb2xlKTtcbiAgICAgIHNzbUVudmlyb25tZW50RW50cmllcy5mb3JFYWNoKCh7IG5hbWUsIHBhdGggfSkgPT4ge1xuICAgICAgICB0aGlzLmZ1bmN0aW9uRW52aXJvbm1lbnRUcmFuc2xhdG9yLmFkZFNzbUVudmlyb25tZW50RW50cnkobmFtZSwgcGF0aCk7XG4gICAgICB9KTtcbiAgICB9LFxuICB9KTtcblxuICAvKipcbiAgICogU3RvcmUgc3RvcmFnZSBvdXRwdXRzIHVzaW5nIHByb3ZpZGVkIHN0cmF0ZWd5XG4gICAqL1xuICBwcml2YXRlIHN0b3JlT3V0cHV0ID0gKFxuICAgIG91dHB1dFN0b3JhZ2VTdHJhdGVneTogQmFja2VuZE91dHB1dFN0b3JhZ2VTdHJhdGVneTxGdW5jdGlvbk91dHB1dD5cbiAgKTogdm9pZCA9PiB7XG4gICAgb3V0cHV0U3RvcmFnZVN0cmF0ZWd5LmFwcGVuZFRvQmFja2VuZE91dHB1dExpc3QoZnVuY3Rpb25PdXRwdXRLZXksIHtcbiAgICAgIHZlcnNpb246ICcxJyxcbiAgICAgIHBheWxvYWQ6IHtcbiAgICAgICAgZGVmaW5lZEZ1bmN0aW9uczogdGhpcy5yZXNvdXJjZXMubGFtYmRhLmZ1bmN0aW9uTmFtZSxcbiAgICAgIH0sXG4gICAgfSk7XG4gIH07XG59XG5cbmNvbnN0IGlzV2hvbGVOdW1iZXJCZXR3ZWVuSW5jbHVzaXZlID0gKFxuICB0ZXN0OiBudW1iZXIsXG4gIG1pbjogbnVtYmVyLFxuICBtYXg6IG51bWJlclxuKSA9PiBtaW4gPD0gdGVzdCAmJiB0ZXN0IDw9IG1heCAmJiB0ZXN0ICUgMSA9PT0gMDtcblxuZXhwb3J0IHR5cGUgTm9kZVZlcnNpb24gPSAxNiB8IDE4IHwgMjA7XG5cbmNvbnN0IG5vZGVWZXJzaW9uTWFwOiBSZWNvcmQ8Tm9kZVZlcnNpb24sIFJ1bnRpbWU+ID0ge1xuICAxNjogUnVudGltZS5OT0RFSlNfMTZfWCxcbiAgMTg6IFJ1bnRpbWUuTk9ERUpTXzE4X1gsXG4gIDIwOiBSdW50aW1lLk5PREVKU18yMF9YLFxufTtcbiJdfQ==